<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">



  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">










<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png?v=6.3.0">


  <link rel="mask-icon" href="/images/favicon.png?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="目标 部署3节点的HA Master(v1.11.1目前最新版)+3个worker node 节点 整个集群使用static pod方式启动包括 使用ipvs替代iptables,实现svc网络 容器部署flannel插件，coredns插件等相关插件">
<meta name="keywords" content="微服务,docker,kubernetes">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes-v1.11.1-全自动ansible部署指南">
<meta property="og:url" content="https://www.qingmu.io/2018/07/31/Kubernetes-v1-11-1-ansible/index.html">
<meta property="og:site_name" content="青木的博客">
<meta property="og:description" content="目标 部署3节点的HA Master(v1.11.1目前最新版)+3个worker node 节点 整个集群使用static pod方式启动包括 使用ipvs替代iptables,实现svc网络 容器部署flannel插件，coredns插件等相关插件">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-08-13T09:35:16.351Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kubernetes-v1.11.1-全自动ansible部署指南">
<meta name="twitter:description" content="目标 部署3节点的HA Master(v1.11.1目前最新版)+3个worker node 节点 整个集群使用static pod方式启动包括 使用ipvs替代iptables,实现svc网络 容器部署flannel插件，coredns插件等相关插件">






  <link rel="canonical" href="https://www.qingmu.io/2018/07/31/Kubernetes-v1-11-1-ansible/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Kubernetes-v1.11.1-全自动ansible部署指南 | 青木的博客</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">青木的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.qingmu.io/2018/07/31/Kubernetes-v1-11-1-ansible/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="freeman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="青木的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Kubernetes-v1.11.1-全自动ansible部署指南
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-07-31 18:24:23" itemprop="dateCreated datePublished" datetime="2018-07-31T18:24:23+08:00">2018-07-31</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-08-13 17:35:16" itemprop="dateModified" datetime="2018-08-13T17:35:16+08:00">2018-08-13</time>
              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/31/Kubernetes-v1-11-1-ansible/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/07/31/Kubernetes-v1-11-1-ansible/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/07/31/Kubernetes-v1-11-1-ansible/" class="leancloud_visitors" data-flag-title="Kubernetes-v1.11.1-全自动ansible部署指南">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><ul>
<li>部署3节点的HA Master(v1.11.1目前最新版)+3个worker node 节点</li>
<li>整个集群使用static pod方式启动包括</li>
<li>使用ipvs替代iptables,实现svc网络</li>
<li>容器部署flannel插件，coredns插件等相关插件</li>
</ul>
<a id="more"></a>
<h1 id="镜像"><a href="#镜像" class="headerlink" title="镜像"></a>镜像</h1><ul>
<li>由于gcr的镜像被墙住了所以这里使用我们自己同步到dockerhub的镜像</li>
<li>我们使用github结合dockerhub自动构建的放松进行镜像的自动同步管理</li>
<li>镜像全部使用freemanliu下同步过来的镜像（<a href="https://hub.docker.com/r/freemanliu/" target="_blank" rel="noopener">https://hub.docker.com/r/freemanliu/</a> ）</li>
<li>镜像Dockerfile 托管在 <a href="https://github.com/goudai/kubernetes-images" target="_blank" rel="noopener">https://github.com/goudai/kubernetes-images</a></li>
<li>大概需要用到到的镜像如下</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY                                                                          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">zhangguanzhang/keepalived                                                           1.3.9               7d0a6d093f78        9 days ago          14MB</span><br><span class="line">freemanliu/kube-proxy-amd64                v1.11.1             d5c25579d0ff        2 weeks ago         97.8MB</span><br><span class="line">freemanliu/kube-scheduler-amd64            v1.11.1             272b3a60cd68        2 weeks ago         56.8MB</span><br><span class="line">freemanliu/kube-controller-manager-amd64   v1.11.1             52096ee87d0e        2 weeks ago         155MB</span><br><span class="line">freemanliu/kube-apiserver-amd64            v1.11.1             816332bd9d11        2 weeks ago         187MB</span><br><span class="line">freemanliu/etcd-amd64                      3.2.18              b8df3b177be2        3 months ago        219MB</span><br><span class="line">freemanliu/flannel                                                              v0.10.0-amd64       f0fad859c909        6 months ago        44.6MB</span><br><span class="line">freemanliu/pause-amd64                     3.1                 da86e6ba6ca1        7 months ago        742kB</span><br><span class="line">kairen/haproxy                                                                      1.7                 733c4b4d75c4        14 months ago       14.7MB</span><br></pre></td></tr></table></figure>
<h1 id="使用软件版本"><a href="#使用软件版本" class="headerlink" title="使用软件版本"></a>使用软件版本</h1><table>
<thead>
<tr>
<th>软件名称</th>
<th>版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>os</td>
<td>centos 7.x</td>
</tr>
<tr>
<td>etcd</td>
<td>v3.2.18</td>
</tr>
<tr>
<td>keepalived</td>
<td>1.3.9</td>
</tr>
<tr>
<td>flannel</td>
<td>v0.10.0-amd64</td>
</tr>
<tr>
<td>haproxy</td>
<td>1.7</td>
</tr>
<tr>
<td>kubernetes</td>
<td>v1.11.1(master=&gt;(kube-apiserver,kube-controller-manager,kube-scheduler))</td>
</tr>
<tr>
<td>ipvsadm</td>
<td>v1.27</td>
</tr>
</tbody>
</table>
<h1 id="主机布局"><a href="#主机布局" class="headerlink" title="主机布局"></a>主机布局</h1><ul>
<li>请按照如下格式修改主机名</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hostname</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>hostname</th>
<th>ip</th>
<th>soft</th>
</tr>
</thead>
<tbody>
<tr>
<td>k8s-m1</td>
<td>192.168.0.101</td>
<td>haproxy,etcd,kubernetes,flannel</td>
</tr>
<tr>
<td>k8s-m2</td>
<td>192.168.0.102</td>
<td>haproxy,etcd,kubernetes,flannel</td>
</tr>
<tr>
<td>k8s-m3</td>
<td>192.168.0.103</td>
<td>haproxy,etcd,kubernetes,flannel</td>
</tr>
<tr>
<td>k8s-n1</td>
<td>192.168.0.104</td>
<td>kube-proxy,flannel</td>
</tr>
<tr>
<td>k8s-n2</td>
<td>192.168.0.105</td>
<td>kube-proxy,flannel</td>
</tr>
<tr>
<td>k8s-n2</td>
<td>192.168.0.106</td>
<td>kube-proxy,flannel</td>
</tr>
</tbody>
</table>
<ul>
<li>新增hosts</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'</span></span><br><span class="line"><span class="string">192.168.0.101 k8s-m1</span></span><br><span class="line"><span class="string">192.168.0.102 k8s-m2</span></span><br><span class="line"><span class="string">192.168.0.103 k8s-m3</span></span><br><span class="line"><span class="string">192.168.0.104 k8s-n1</span></span><br><span class="line"><span class="string">192.168.0.105 k8s-n2</span></span><br><span class="line"><span class="string">192.168.0.106 k8s-n3</span></span><br><span class="line"><span class="string">'</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>
<h1 id="环境准备-以下操作请在每一台主机执行，请确保使用root用户"><a href="#环境准备-以下操作请在每一台主机执行，请确保使用root用户" class="headerlink" title="环境准备(以下操作请在每一台主机执行，请确保使用root用户)"></a>环境准备(以下操作请在每一台主机执行，请确保使用root用户)</h1><ul>
<li>可在一台主机完成以下操作后制作相关镜像，使用镜像分发</li>
</ul>
<h2 id="linux环境设置"><a href="#linux环境设置" class="headerlink" title="linux环境设置"></a>linux环境设置</h2><ul>
<li>配置阿里云yum源</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#备份</span></span><br><span class="line">mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</span><br><span class="line"><span class="comment"># 添加阿里云repo</span></span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"><span class="comment">#生成缓存</span></span><br><span class="line">yum makecache</span><br></pre></td></tr></table></figure>
<ul>
<li>安装ipvsadm,wget ,socat</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ipvsadm wget  socat</span><br></pre></td></tr></table></figure>
<ul>
<li>加载内核ipvs模块</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">ipvs_modules=<span class="string">"ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_fo ip_vs_nq ip_vs_sed  nf_conntrack_ipv4"</span></span><br><span class="line"><span class="keyword">for</span> kernel_module <span class="keyword">in</span> \<span class="variable">$&#123;ipvs_modules&#125;</span>; <span class="keyword">do</span></span><br><span class="line">    /sbin/modinfo -F filename \<span class="variable">$&#123;kernel_module&#125;</span> &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">    <span class="keyword">if</span> [ \$? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">        /sbin/modprobe \<span class="variable">$&#123;kernel_module&#125;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">EOF</span><br><span class="line">chmod +x /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep ip_vs</span><br></pre></td></tr></table></figure>
<ul>
<li>正确加载之后输出如下</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">nf_nat                 26787  3 ip_vs_ftp,nf_nat_ipv4,nf_nat_masquerade_ipv4</span><br><span class="line">ip_vs_sed              12519  0</span><br><span class="line">ip_vs_nq               12516  0</span><br><span class="line">ip_vs_sh               12688  0</span><br><span class="line">ip_vs_dh               12688  0</span><br><span class="line">ip_vs_lblcr            12922  0</span><br><span class="line">ip_vs_lblc             12819  0</span><br><span class="line">ip_vs_wrr              12697  0</span><br><span class="line">ip_vs_rr               12600  9</span><br><span class="line">ip_vs_wlc              12519  0</span><br><span class="line">ip_vs_lc               12516  0</span><br><span class="line">ip_vs                 141473  31 ip_vs_dh,ip_vs_lc,ip_vs_nq,ip_vs_rr,ip_vs_sh,ip_vs_ftp,ip_vs_sed,ip_vs_wlc,ip_vs_wrr,ip_vs_lblcr,ip_vs_lblc</span><br><span class="line">nf_conntrack          133053  7 ip_vs,nf_nat,nf_nat_ipv4,xt_conntrack,nf_nat_masquerade_ipv4,nf_conntrack_netlink,nf_conntrack_ipv4</span><br><span class="line">libcrc32c              12644  4 xfs,ip_vs,nf_nat,nf_conntrack</span><br></pre></td></tr></table></figure>
<ul>
<li>关闭防火墙，设置内核参数，关闭swap</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'net.ipv6.conf.all.disable_ipv6 = 1</span></span><br><span class="line"><span class="string">net.ipv6.conf.default.disable_ipv6 = 1</span></span><br><span class="line"><span class="string">net.ipv6.conf.lo.disable_ipv6 = 1</span></span><br><span class="line"><span class="string">vm.swappiness = 0</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_stale_time = 120</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.rp_filter = 0</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.rp_filter = 0</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.arp_announce = 2</span></span><br><span class="line"><span class="string">net.ipv4.conf.lo.arp_announce = 2</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.arp_announce = 2</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_tw_buckets = 5000</span></span><br><span class="line"><span class="string">net.ipv4.tcp_syncookies = 1</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_syn_backlog = 1024</span></span><br><span class="line"><span class="string">net.ipv4.tcp_synack_retries = 2</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-arptables = 1</span></span><br><span class="line"><span class="string">fs.may_detach_mounts = 1'</span> &gt; /etc/sysctl.conf</span><br><span class="line">&amp;&amp; swapoff -a</span><br><span class="line">&amp;&amp; sysctl -w vm.swappiness=0</span><br><span class="line">&amp;&amp; sed -ri <span class="string">'/^[^#]*swap/s@^@#@'</span> /etc/fstab</span><br><span class="line">&amp;&amp; systemctl <span class="built_in">disable</span> --now firewalld</span><br></pre></td></tr></table></figure>
<ul>
<li>关闭selinux</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将SELINUX=enforcing改为SELINUX=disabled</span></span><br><span class="line">vim /etc/selinux/config</span><br><span class="line"><span class="comment"># 确保 getenforce 命令输出 Disabled</span></span><br><span class="line">getenforce</span><br></pre></td></tr></table></figure>
<ul>
<li>确保如下输出为1</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/sys/net/ipv4/ip_forward</span><br><span class="line">1</span><br></pre></td></tr></table></figure>
<h2 id="docker-安装"><a href="#docker-安装" class="headerlink" title="docker 安装"></a>docker 安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1: 安装必要的一些系统工具</span></span><br><span class="line">sudo yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line"><span class="comment"># Step 2: 添加软件源信息</span></span><br><span class="line">sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"><span class="comment"># Step 3: 更新并安装 Docker-CE</span></span><br><span class="line">sudo yum makecache fast</span><br><span class="line">sudo yum -y install docker-ce</span><br><span class="line"><span class="comment"># Step 4: 开启Docker服务</span></span><br><span class="line">systemctl start docker</span><br><span class="line"><span class="comment"># 开启开机自启</span></span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line"><span class="comment"># 安装指定版本的Docker-CE:</span></span><br><span class="line"><span class="comment"># Step 1: 查找Docker-CE的版本:</span></span><br><span class="line"><span class="comment"># yum list docker-ce.x86_64 --showduplicates | sort -r</span></span><br><span class="line"><span class="comment">#   Loading mirror speeds from cached hostfile</span></span><br><span class="line"><span class="comment">#   Loaded plugins: branch, fastestmirror, langpacks</span></span><br><span class="line"><span class="comment">#   docker-ce.x86_64            17.03.1.ce-1.el7.centos            docker-ce-stable</span></span><br><span class="line"><span class="comment">#   docker-ce.x86_64            17.03.1.ce-1.el7.centos            @docker-ce-stable</span></span><br><span class="line"><span class="comment">#   docker-ce.x86_64            17.03.0.ce-1.el7.centos            docker-ce-stable</span></span><br><span class="line"><span class="comment">#   Available Packages</span></span><br><span class="line"><span class="comment"># Step2 : 安装指定版本的Docker-CE: (VERSION 例如上面的 17.03.0.ce.1-1.el7.centos)</span></span><br><span class="line"><span class="comment"># sudo yum -y install docker-ce-[VERSION]</span></span><br></pre></td></tr></table></figure>
<ul>
<li>设置docker加速镜像</li>
<li>这里使用阿里云提供的镜像服务，需自己去注册后替换</li>
<li>阿里云镜像<a href="https://helpcdn.aliyun.com/document_detail/60750.html" target="_blank" rel="noopener">帮助指南</a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/docker/</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">"registry-mirrors": ["https://xxxx.mirror.aliyuncs.com"]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span> &gt; /etc/docker/daemon.json</span><br></pre></td></tr></table></figure>
<ul>
<li>完成操作之后请reboot 重启host</li>
</ul>
<h1 id="一下操作任选一台MASTER节点操作即可（这里选择k8s-m1）"><a href="#一下操作任选一台MASTER节点操作即可（这里选择k8s-m1）" class="headerlink" title="一下操作任选一台MASTER节点操作即可（这里选择k8s-m1）"></a>一下操作任选一台MASTER节点操作即可（这里选择k8s-m1）</h1><ul>
<li>安装必须软件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ansible git</span><br></pre></td></tr></table></figure>
<ul>
<li>下载kubernetes（主要使用到kubelet和kuberctl）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在~目录操作</span></span><br><span class="line"><span class="built_in">cd</span> ~/</span><br><span class="line"><span class="comment"># 自备梯子</span></span><br><span class="line">wget https://storage.googleapis.com/kubernetes-release/release/v1.11.1/kubernetes-node-linux-amd64.tar.gz</span><br><span class="line"><span class="comment"># 无梯子 国内七牛云CDN</span></span><br><span class="line">wget http://ols7lqkih.bkt.clouddn.com/kubernetes-node-linux-amd64-v1.11.1.tar.gz</span><br><span class="line"><span class="comment">#无梯子 百度云盘</span></span><br><span class="line">链接: https://pan.baidu.com/s/1kbz1X_MH3XIjIXiG80tBmA 密码: rk4j</span><br></pre></td></tr></table></figure>
<ul>
<li>clone ansible 脚本项目</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/goudai/ansible-kubernetes-v1.11.1-ipvs.git</span><br><span class="line"><span class="comment"># 解压缩 kubernetes</span></span><br><span class="line">tar xf kubernetes-node-linux-amd64.tar.gz</span><br><span class="line"><span class="comment"># copy 需要的文件到ansbile 的分发目录中,这两个文件会被分发到集群中所有机器</span></span><br><span class="line">cp kubernetes/node/bin/&#123;kubectl,kubelet&#125; ansible-kubernetes-v1.11.1-ipvs/roles/scp/files</span><br></pre></td></tr></table></figure>
<ul>
<li>修改hosts文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#切换到项目目录</span></span><br><span class="line"><span class="built_in">cd</span> ~/ansible-kubernetes-v1.11.1-ipvs</span><br><span class="line"><span class="comment">#修改hosts 文件 </span></span><br><span class="line">vim hosts</span><br><span class="line"><span class="comment">#把文件中一下ip替换为自己的ip</span></span><br><span class="line">[otherMaster] <span class="comment">#替换为你的k8s-m2,k8s-m3的ip</span></span><br><span class="line">192.168.0.102 </span><br><span class="line">192.168.0.103</span><br><span class="line"><span class="comment"># 如果每个每个机器的密码不一致，请使用如下格式</span></span><br><span class="line"><span class="comment"># 并注释 group_vars/all.yml 中的 ansible_ssh_pass: 111111 这一行</span></span><br><span class="line"><span class="comment"># 192.168.0.102  ansible_ssh_pass=password1  ansible_ssh_port=22</span></span><br><span class="line"><span class="comment"># 192.168.0.103  ansible_ssh_pass=password2  ansible_ssh_port=22</span></span><br><span class="line">[Node] <span class="comment"># 替换为你的k8s-n1 的ip</span></span><br><span class="line">192.168.0.104</span><br></pre></td></tr></table></figure>
<ul>
<li>修改全局变量参数group_vars/all.yml</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/ansible-kubernetes-v1.11.1-ipvs</span><br><span class="line">vim group_vars/all.yml</span><br><span class="line"><span class="comment"># TOKEN相关信息可以不用修改 如想修改可以用如下方式重新生成</span></span><br><span class="line"><span class="comment"># TOKEN可以使用head -c 32 /dev/urandom | base64生成替换</span></span><br><span class="line"><span class="comment"># TOKEN_ID可以使用openssl rand 3 -hex生成</span></span><br><span class="line"><span class="comment"># TOKEN_SECRET使用openssl rand 8 -hex</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># VIP 和 NETMASK 修改</span></span><br><span class="line"><span class="comment"># 这里的VIP 是keepalived 所要使用的 VIP ，修改为你所在网段的未使用的IP即可 </span></span><br><span class="line"><span class="comment"># NETMASK 为VIP的掩码</span></span><br><span class="line"><span class="comment"># INTERFACE_NAME 为让vip绑定的网卡</span></span><br></pre></td></tr></table></figure>
<ul>
<li>其余相关参数如果特殊要求可不更改</li>
</ul>
<h1 id="开始自动化部署"><a href="#开始自动化部署" class="headerlink" title="开始自动化部署"></a>开始自动化部署</h1><ul>
<li>分发 /etc/hosts 文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主要保证master机器上都有上面修改的hosts信息 </span></span><br><span class="line">ansible all -m copy -a <span class="string">"src=/etc/hosts dest=/etc/hosts"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>分发kubectl,kubelet,cfssl,cni </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook distribute-file.yml</span><br></pre></td></tr></table></figure>
<ul>
<li>生成 etcd 和 kubernetes 所需要证书并分发到所有节点</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/ansible-kubernetes-v1.11.1-ipvs</span><br><span class="line">ansible-playbook gen-etcd-ca-kubenetes-ca.yml</span><br></pre></td></tr></table></figure>
<ul>
<li>部署master kubelet systemd 方式部署 并启动</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/ansible-kubernetes-v1.11.1-ipvs</span><br><span class="line">ansible-playbook deploy-master.yml</span><br></pre></td></tr></table></figure>
<ul>
<li>部署执行完成之后 请等待kubernetes集群 启动完成</li>
<li>可通过tail -f /var/log/messages 查看kubelet相关日志输出</li>
<li>正确启动成功之后的输出如下</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m1 kubernetes]<span class="comment"># kubectl get cs</span></span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">scheduler            Healthy   ok                   </span><br><span class="line">controller-manager   Healthy   ok                   </span><br><span class="line">etcd-2               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;   </span><br><span class="line">etcd-1               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125; </span><br><span class="line"></span><br><span class="line">[root@k8s-m1 kubernetes]<span class="comment"># kubectl get svc</span></span><br><span class="line">kubernetes                 ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP        23h</span><br><span class="line"></span><br><span class="line">[root@k8s-m1 kubernetes]<span class="comment"># kubectl get node</span></span><br><span class="line">NAME      STATUS     ROLES     AGE       VERSION</span><br><span class="line">k8s-m1    NotReady   master    52s       v1.11.1</span><br><span class="line">k8s-m2    NotReady   master    51s       v1.11.1</span><br><span class="line">k8s-m3    NotReady   master    50s       v1.11.1</span><br><span class="line"></span><br><span class="line">[root@k8s-m1 kubernetes]<span class="comment"># kubectl -n kube-system get po</span></span><br><span class="line">NAME                             READY     STATUS    RESTARTS   AGE</span><br><span class="line">etcd-k8s-m1                      1/1       Running   0          7m</span><br><span class="line">etcd-k8s-m2                      1/1       Running   0          8m</span><br><span class="line">etcd-k8s-m3                      1/1       Running   0          7m</span><br><span class="line">haproxy-k8s-m1                   1/1       Running   0          7m</span><br><span class="line">haproxy-k8s-m2                   1/1       Running   0          8m</span><br><span class="line">haproxy-k8s-m3                   1/1       Running   0          8m</span><br><span class="line">keepalived-k8s-m1                1/1       Running   0          8m</span><br><span class="line">keepalived-k8s-m2                1/1       Running   0          7m</span><br><span class="line">keepalived-k8s-m3                1/1       Running   0          7m</span><br><span class="line">kube-apiserver-k8s-m1            1/1       Running   0          7m</span><br><span class="line">kube-apiserver-k8s-m2            1/1       Running   0          6m</span><br><span class="line">kube-apiserver-k8s-m3            1/1       Running   0          7m</span><br><span class="line">kube-controller-manager-k8s-m1   1/1       Running   0          8m</span><br><span class="line">kube-controller-manager-k8s-m2   1/1       Running   0          8m</span><br><span class="line">kube-controller-manager-k8s-m3   1/1       Running   0          8m</span><br><span class="line">kube-scheduler-k8s-m1            1/1       Running   0          8m</span><br><span class="line">kube-scheduler-k8s-m2            1/1       Running   0          8m</span><br><span class="line">kube-scheduler-k8s-m3            1/1       Running   0          8m</span><br></pre></td></tr></table></figure>
<ul>
<li>启用 Bootstrap Tokens 认证</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/ansible-kubernetes-v1.11.1-ipvs</span><br><span class="line">ansible-playbook tls-bootstrap-autoapprove-RBAC.yml</span><br><span class="line"><span class="comment"># 查看csr</span></span><br><span class="line">[root@k8s-m1 ansible-kubernetes-v1.11.1-ipvs]<span class="comment"># kubectl get csr</span></span><br><span class="line">NAME        AGE       REQUESTOR            CONDITION</span><br><span class="line">csr-5l8dr   1m        system:node:k8s-m3   Approved,Issued</span><br><span class="line">csr-chcb4   1m        system:node:k8s-m2   Approved,Issued</span><br><span class="line">csr-sb9f6   1m        system:node:k8s-m1   Approved,Issued</span><br></pre></td></tr></table></figure>
<ul>
<li>至此 kubernetes 三节点HA的master部署完毕</li>
</ul>
<h1 id="添加node节点"><a href="#添加node节点" class="headerlink" title="添加node节点"></a>添加node节点</h1><ul>
<li>默认添加hosts文件中的[Node] 熟悉的host </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/ansible-kubernetes-v1.11.1-ipvs</span><br><span class="line"><span class="comment">#请保证执行以前脚本前hosts中[Node] 属性没有已经添加过的节点 </span></span><br><span class="line">ansible-playbook add-node.yml</span><br><span class="line"><span class="comment">#成功添加节点之后 请注释掉hosts中的所有节点 下次新增节点的时候 继续追加host即可</span></span><br></pre></td></tr></table></figure>
<h1 id="添加插件"><a href="#添加插件" class="headerlink" title="添加插件"></a>添加插件</h1><ul>
<li>所有插件都使用容器进行部署</li>
</ul>
<h2 id="部署kube-proxy-插件"><a href="#部署kube-proxy-插件" class="headerlink" title="部署kube-proxy 插件"></a>部署kube-proxy 插件</h2><ul>
<li>如clusterCIDR 有改动 请替换掉 ‘10.244.0.0/16’</li>
<li>将 ${<a href="https://vip:6443}" target="_blank" rel="noopener">https://vip:6443}</a> 替换成为 group_vars/all.yml 中的vip </li>
<li>如 vip = 192.168.0.110 则 ${<a href="https://vip:6443}" target="_blank" rel="noopener">https://vip:6443}</a>  替换为 <a href="https://192.168.0.110:6443" target="_blank" rel="noopener">https://192.168.0.110:6443</a></li>
<li>替换完成之后 新建一个kube-proxy.yml的文件 写入替换之后的内容</li>
<li>在任意master上执行 kubectl apply -f kube-proxy.yml 即可完成proxy的部署<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#kub-proxy.yml</span></span><br><span class="line"><span class="comment"># 镜像 registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy-amd64:v1.11.1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    <span class="string">addonmanager.kubernetes.io/mode:</span> <span class="string">Reconcile</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="attr">system:kube-proxy</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    <span class="string">addonmanager.kubernetes.io/mode:</span> <span class="string">Reconcile</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="attr">system:node-proxier</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">config.conf:</span> <span class="string">|-</span></span><br><span class="line"><span class="attr">    apiVersion:</span> <span class="string">kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">    bindAddress:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">    clientConnection:</span></span><br><span class="line"><span class="attr">      acceptContentTypes:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      burst:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">      contentType:</span> <span class="string">application/vnd.kubernetes.protobuf</span></span><br><span class="line"><span class="attr">      kubeconfig:</span> <span class="string">/var/lib/kube-proxy/kubeconfig.conf</span></span><br><span class="line"><span class="attr">      qps:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">    clusterCIDR:</span> <span class="string">'10.244.0.0/16'</span></span><br><span class="line"><span class="attr">    configSyncPeriod:</span> <span class="number">15</span><span class="string">m0s</span></span><br><span class="line"><span class="attr">    conntrack:</span></span><br><span class="line"><span class="attr">      max:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">      maxPerCore:</span> <span class="number">32768</span></span><br><span class="line"><span class="attr">      min:</span> <span class="number">131072</span></span><br><span class="line"><span class="attr">      tcpCloseWaitTimeout:</span> <span class="number">1</span><span class="string">h0m0s</span></span><br><span class="line"><span class="attr">      tcpEstablishedTimeout:</span> <span class="number">24</span><span class="string">h0m0s</span></span><br><span class="line"><span class="attr">    enableProfiling:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    healthzBindAddress:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:10256</span></span><br><span class="line"><span class="attr">    hostnameOverride:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    iptables:</span></span><br><span class="line"><span class="attr">      masqueradeAll:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      masqueradeBit:</span> <span class="number">14</span></span><br><span class="line"><span class="attr">      minSyncPeriod:</span> <span class="number">0</span><span class="string">s</span></span><br><span class="line"><span class="attr">      syncPeriod:</span> <span class="number">30</span><span class="string">s</span></span><br><span class="line"><span class="attr">    ipvs:</span></span><br><span class="line"><span class="attr">      masqueradeAll:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      minSyncPeriod:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">      scheduler:</span> <span class="string">"rr"</span></span><br><span class="line"><span class="attr">      syncPeriod:</span> <span class="number">30</span><span class="string">s</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">KubeProxyConfiguration</span></span><br><span class="line"><span class="attr">    metricsBindAddress:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:10249</span></span><br><span class="line"><span class="attr">    mode:</span> <span class="string">"ipvs"</span></span><br><span class="line"><span class="attr">    nodePortAddresses:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">    oomScoreAdj:</span> <span class="bullet">-999</span></span><br><span class="line"><span class="attr">    portRange:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    resourceContainer:</span> <span class="string">/kube-proxy</span></span><br><span class="line"><span class="attr">    udpIdleTimeout:</span> <span class="number">250</span><span class="string">ms</span></span><br><span class="line">  <span class="string">kubeconfig.conf:</span> <span class="string">|-</span></span><br><span class="line"><span class="attr">    apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">    clusters:</span></span><br><span class="line"><span class="attr">    - cluster:</span></span><br><span class="line"><span class="attr">        certificate-authority:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line"><span class="attr">        server:</span> <span class="string">$&#123;https://vip:6443&#125;</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">    contexts:</span></span><br><span class="line"><span class="attr">    - context:</span></span><br><span class="line"><span class="attr">        cluster:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">        namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">        user:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">    current-context:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">    users:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">      user:</span></span><br><span class="line"><span class="attr">        tokenFile:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      k8s-app:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        k8s-app:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      tolerations:</span></span><br><span class="line"><span class="attr">      - effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">        key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line"><span class="attr">      - effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">        key:</span> <span class="string">node.cloudprovider.kubernetes.io/uninitialized</span></span><br><span class="line"><span class="attr">        value:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">      hostNetwork:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">      serviceAccount:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy-amd64:v1.11.1</span></span><br><span class="line"><span class="attr">        command:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">/usr/local/bin/kube-proxy</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--config=/var/lib/kube-proxy/config.conf</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--v=2</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        securityContext:</span></span><br><span class="line"><span class="attr">          privileged:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - mountPath:</span> <span class="string">/var/lib/kube-proxy</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">        - mountPath:</span> <span class="string">/run/xtables.lock</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">xtables-lock</span></span><br><span class="line"><span class="attr">        - mountPath:</span> <span class="string">/lib/modules</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">lib-modules</span></span><br><span class="line"><span class="attr">          readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - configMap:</span></span><br><span class="line"><span class="attr">          defaultMode:</span> <span class="number">420</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">      - hostPath:</span></span><br><span class="line"><span class="attr">          path:</span> <span class="string">/run/xtables.lock</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">FileOrCreate</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">xtables-lock</span></span><br><span class="line"><span class="attr">      - hostPath:</span></span><br><span class="line"><span class="attr">          path:</span> <span class="string">/lib/modules</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">lib-modules</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="部署flannel-插件"><a href="#部署flannel-插件" class="headerlink" title="部署flannel 插件"></a>部署flannel 插件</h2><ul>
<li>如Network 有改动 请替换掉 ‘10.244.0.0/16’</li>
<li>在任意master上 新建一个kube-flannel.yml的文件 </li>
<li>kubectl apply -f kube-flannel.yml 即可完成flannel的部署</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#kube-flannel.yml</span></span><br><span class="line"><span class="comment"># 镜像 quay.io/coreos/flannel:v0.10.0-amd64</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">pods</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nodes</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nodes/status</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">patch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kube-flannel-cfg</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    tier:</span> <span class="string">node</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">cni-conf.json:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      "name": "cbr0",</span></span><br><span class="line"><span class="string">      "plugins": [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          "type": "flannel",</span></span><br><span class="line"><span class="string">          "delegate": &#123;</span></span><br><span class="line"><span class="string">            "hairpinMode": true,</span></span><br><span class="line"><span class="string">            "isDefaultGateway": true</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          "type": "portmap",</span></span><br><span class="line"><span class="string">          "capabilities": &#123;</span></span><br><span class="line"><span class="string">            "portMappings": true</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      ]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  net-conf.json: |</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      "Network": "10.244.0.0/16",</span></span><br><span class="line"><span class="string">      "Backend": &#123;</span></span><br><span class="line"><span class="string">        "Type": "vxlan"</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kube-flannel-ds</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    tier:</span> <span class="string">node</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        tier:</span> <span class="string">node</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      hostNetwork:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      nodeSelector:</span></span><br><span class="line">        <span class="string">beta.kubernetes.io/arch:</span> <span class="string">amd64</span></span><br><span class="line"><span class="attr">      tolerations:</span></span><br><span class="line"><span class="attr">      - key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line"><span class="attr">        operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="attr">        effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">      initContainers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">install-cni</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">quay.io/coreos/flannel:v0.10.0-amd64</span></span><br><span class="line"><span class="attr">        command:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">cp</span></span><br><span class="line"><span class="attr">        args:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">-f</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">/etc/kube-flannel/cni-conf.json</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">/etc/cni/net.d/10-flannel.conflist</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">cni</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/etc/cni/net.d</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">flannel-cfg</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/etc/kube-flannel/</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">kube-flannel</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">quay.io/coreos/flannel:v0.10.0-amd64</span></span><br><span class="line"><span class="attr">        command:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">/opt/bin/flanneld</span></span><br><span class="line"><span class="attr">        args:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--ip-masq</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--kube-subnet-mgr</span></span><br><span class="line"><span class="attr">        resources:</span></span><br><span class="line"><span class="attr">          requests:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="string">"100m"</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="string">"50Mi"</span></span><br><span class="line"><span class="attr">          limits:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="string">"100m"</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="string">"50Mi"</span></span><br><span class="line"><span class="attr">        securityContext:</span></span><br><span class="line"><span class="attr">          privileged:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">POD_NAME</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">run</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/run</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">flannel-cfg</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/etc/kube-flannel/</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">run</span></span><br><span class="line"><span class="attr">        hostPath:</span></span><br><span class="line"><span class="attr">          path:</span> <span class="string">/run</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">cni</span></span><br><span class="line"><span class="attr">        hostPath:</span></span><br><span class="line"><span class="attr">          path:</span> <span class="string">/etc/cni/net.d</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">flannel-cfg</span></span><br><span class="line"><span class="attr">        configMap:</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">kube-flannel-cfg</span></span><br></pre></td></tr></table></figure>
<h2 id="部署coredns"><a href="#部署coredns" class="headerlink" title="部署coredns"></a>部署coredns</h2><ul>
<li>coredns.yml 无法直接使用需要填入自己的dnsip 故使用coredns.yaml.sed+deploy.sh 完成yml文件的生成</li>
<li>新建如下两个文件 给deploy +x 执行权限</li>
<li>./deploy.sh -i  ${ClusterDns} 这里的ClusterDns 取group_vars/all.yml中的ClusterDns即可</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># deploy.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Deploys CoreDNS to a cluster currently running Kube-DNS.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">show_help</span></span> () &#123;</span><br><span class="line">cat &lt;&lt; USAGE</span><br><span class="line">usage: <span class="variable">$0</span> [ -r REVERSE-CIDR ] [ -i DNS-IP ] [ -d CLUSTER-DOMAIN ] [ -t YAML-TEMPLATE ]</span><br><span class="line">    -r : Define a reverse zone <span class="keyword">for</span> the given CIDR. You may specifcy this option more</span><br><span class="line">         than once to add multiple reverse zones. If no reverse CIDRs are defined,</span><br><span class="line">         <span class="keyword">then</span> the default is to handle all reverse zones (i.e. <span class="keyword">in</span>-addr.arpa and ip6.arpa)</span><br><span class="line">    -i : Specify the cluster DNS IP address. If not specificed, the IP address of</span><br><span class="line">         the existing <span class="string">"kube-dns"</span> service is used, <span class="keyword">if</span> present.</span><br><span class="line">USAGE</span><br><span class="line"><span class="built_in">exit</span> 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Simple Defaults</span></span><br><span class="line">CLUSTER_DOMAIN=cluster.local</span><br><span class="line">YAML_TEMPLATE=`<span class="built_in">pwd</span>`/coredns.yaml.sed</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Get Opts</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">getopts</span> <span class="string">"hr:i:d:t:"</span> opt; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"<span class="variable">$opt</span>"</span> <span class="keyword">in</span></span><br><span class="line">    h)  show_help</span><br><span class="line">        ;;</span><br><span class="line">    r)  REVERSE_CIDRS=<span class="string">"<span class="variable">$REVERSE_CIDRS</span> <span class="variable">$OPTARG</span>"</span></span><br><span class="line">        ;;</span><br><span class="line">    i)  CLUSTER_DNS_IP=<span class="variable">$OPTARG</span></span><br><span class="line">        ;;</span><br><span class="line">    d)  CLUSTER_DOMAIN=<span class="variable">$OPTARG</span></span><br><span class="line">        ;;</span><br><span class="line">    t)  YAML_TEMPLATE=<span class="variable">$OPTARG</span></span><br><span class="line">        ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Conditional Defaults</span></span><br><span class="line"><span class="keyword">if</span> [[ -z <span class="variable">$REVERSE_CIDRS</span> ]]; <span class="keyword">then</span></span><br><span class="line">  REVERSE_CIDRS=<span class="string">"in-addr.arpa ip6.arpa"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [[ -z <span class="variable">$CLUSTER_DNS_IP</span> ]]; <span class="keyword">then</span></span><br><span class="line">  <span class="comment"># Default IP to kube-dns IP</span></span><br><span class="line">  CLUSTER_DNS_IP=$(kubectl get service --namespace kube-system kube-dns -o jsonpath=<span class="string">"&#123;.spec.clusterIP&#125;"</span>)</span><br><span class="line">  <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">      &gt;&amp;2 <span class="built_in">echo</span> <span class="string">"Error! The IP address for DNS service couldn't be determined automatically. Please specify the DNS-IP with the '-i' option."</span></span><br><span class="line">      <span class="built_in">exit</span> 2</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">sed -e s/CLUSTER_DNS_IP/<span class="variable">$CLUSTER_DNS_IP</span>/g -e s/CLUSTER_DOMAIN/<span class="variable">$CLUSTER_DOMAIN</span>/g -e <span class="string">"s?REVERSE_CIDRS?<span class="variable">$REVERSE_CIDRS</span>?g"</span> <span class="variable">$YAML_TEMPLATE</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coredns.yaml.sed</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">coredns</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    <span class="string">kubernetes.io/bootstrapping:</span> <span class="string">rbac-defaults</span></span><br><span class="line"><span class="attr">  name:</span> <span class="attr">system:coredns</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">endpoints</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">services</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">pods</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">namespaces</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">rbac.authorization.kubernetes.io/autoupdate:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    <span class="string">kubernetes.io/bootstrapping:</span> <span class="string">rbac-defaults</span></span><br><span class="line"><span class="attr">  name:</span> <span class="attr">system:coredns</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="attr">system:coredns</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">coredns</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">coredns</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  Corefile:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    .:53 &#123;</span></span><br><span class="line"><span class="string">        errors</span></span><br><span class="line"><span class="string">        health</span></span><br><span class="line"><span class="string">        kubernetes CLUSTER_DOMAIN REVERSE_CIDRS &#123;</span></span><br><span class="line"><span class="string">          pods insecure</span></span><br><span class="line"><span class="string">          upstream</span></span><br><span class="line"><span class="string">          fallthrough in-addr.arpa ip6.arpa</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        prometheus :9153</span></span><br><span class="line"><span class="string">        proxy . /etc/resolv.conf</span></span><br><span class="line"><span class="string">        cache 30</span></span><br><span class="line"><span class="string">        reload</span></span><br><span class="line"><span class="string">        loadbalance</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">coredns</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line">    <span class="string">kubernetes.io/name:</span> <span class="string">"CoreDNS"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  strategy:</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">RollingUpdate</span></span><br><span class="line"><span class="attr">    rollingUpdate:</span></span><br><span class="line"><span class="attr">      maxUnavailable:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">coredns</span></span><br><span class="line"><span class="attr">      tolerations:</span></span><br><span class="line"><span class="attr">        - key:</span> <span class="string">"CriticalAddonsOnly"</span></span><br><span class="line"><span class="attr">          operator:</span> <span class="string">"Exists"</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">coredns</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">coredns/coredns:1.2.0</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        args:</span> <span class="string">[</span> <span class="string">"-conf"</span><span class="string">,</span> <span class="string">"/etc/coredns/Corefile"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">config-volume</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/etc/coredns</span></span><br><span class="line"><span class="attr">          readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">53</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">dns</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">UDP</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">53</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">dns-tcp</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">9153</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">metrics</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        securityContext:</span></span><br><span class="line"><span class="attr">          allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">          capabilities:</span></span><br><span class="line"><span class="attr">            add:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">NET_BIND_SERVICE</span></span><br><span class="line"><span class="attr">            drop:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">all</span></span><br><span class="line"><span class="attr">          readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        livenessProbe:</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/health</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">            scheme:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">          successThreshold:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">      dnsPolicy:</span> <span class="string">Default</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">config-volume</span></span><br><span class="line"><span class="attr">          configMap:</span></span><br><span class="line"><span class="attr">            name:</span> <span class="string">coredns</span></span><br><span class="line"><span class="attr">            items:</span></span><br><span class="line"><span class="attr">            - key:</span> <span class="string">Corefile</span></span><br><span class="line"><span class="attr">              path:</span> <span class="string">Corefile</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kube-dns</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">prometheus.io/port:</span> <span class="string">"9153"</span></span><br><span class="line">    <span class="string">prometheus.io/scrape:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line">    <span class="string">kubernetes.io/cluster-service:</span> <span class="string">"true"</span></span><br><span class="line">    <span class="string">kubernetes.io/name:</span> <span class="string">"CoreDNS"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line"><span class="attr">  clusterIP:</span> <span class="string">CLUSTER_DNS_IP</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">dns</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">53</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">UDP</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">dns-tcp</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">53</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure>
<h2 id="部署Dashboard"><a href="#部署Dashboard" class="headerlink" title="部署Dashboard"></a>部署Dashboard</h2><ul>
<li>部署dashboard 插件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml</span><br><span class="line"><span class="comment">#查看部署情况</span></span><br><span class="line">kubectl -n kube-system get po,svc -l k8s-app=kubernetes-dashboard</span><br></pre></td></tr></table></figure>
<ul>
<li>创建open-api  Cluster Role Binding</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | kubectl create -f -</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: open-api</span><br><span class="line">  namespace: <span class="string">""</span></span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">  - apiGroup: rbac.authorization.k8s.io</span><br><span class="line">    kind: User</span><br><span class="line">    name: system:anonymous</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>创建dashboard service account </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system create sa dashboard</span><br><span class="line">kubectl create clusterrolebinding dashboard --clusterrole cluster-admin --serviceaccount=kube-system:dashboard</span><br></pre></td></tr></table></figure>
<ul>
<li>获取login token</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system describe secrets | sed -rn <span class="string">'/\sdashboard-token-/,/^token/&#123;/^token/s#\S+\s+##p&#125;'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>dashboard url 地址</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://&#123;vip&#125;:6443/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/</span><br></pre></td></tr></table></figure>
<h1 id="kubectl-自动补全"><a href="#kubectl-自动补全" class="headerlink" title="kubectl 自动补全"></a>kubectl 自动补全</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install -y bash-completion</span><br><span class="line"> <span class="built_in">source</span> /usr/share/bash-completion/bash_completion</span><br><span class="line"><span class="built_in">source</span> &lt;(kubectl completion bash)</span><br><span class="line">可以将 <span class="built_in">source</span> &lt;(kubectl completion bash) 命令 写入 <span class="variable">$HOME</span>/.bashrc中.</span><br></pre></td></tr></table></figure>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://zhangguanzhang.github.io/2018/05/05/Kubernetes_install/" target="_blank" rel="noopener">https://zhangguanzhang.github.io/2018/05/05/Kubernetes_install/</a></li>
<li><a href="https://github.com/zhangguanzhang/Kubernetes-ansible" target="_blank" rel="noopener">https://github.com/zhangguanzhang/Kubernetes-ansible</a></li>
<li><a href="https://blog.csdn.net/weiyuefei/article/details/52595082" target="_blank" rel="noopener">https://blog.csdn.net/weiyuefei/article/details/52595082</a> （IPVS）</li>
<li><a href="http://www.linuxvirtualserver.org/zh" target="_blank" rel="noopener">http://www.linuxvirtualserver.org/zh</a> (LVS)</li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzU1OTAzNzc5MQ==&amp;mid=2247485610&amp;idx=1&amp;sn=e092e55c848af62368835d530c57da15&amp;chksm=fc1c249acb6bad8c940c587e59e0dc63ba4863c7063f0a0e322dcbd6ad5f610cd2ad1b4ba87d&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">https://mp.weixin.qq.com/s?__biz=MzU1OTAzNzc5MQ==&amp;mid=2247485610&amp;idx=1&amp;sn=e092e55c848af62368835d530c57da15&amp;chksm=fc1c249acb6bad8c940c587e59e0dc63ba4863c7063f0a0e322dcbd6ad5f610cd2ad1b4ba87d&amp;scene=21#wechat_redirect</a> (ipvs VS iptables)</li>
</ul>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/微服务/" rel="tag"># 微服务</a>
          
            <a href="/tags/docker/" rel="tag"># docker</a>
          
            <a href="/tags/kubernetes/" rel="tag"># kubernetes</a>
          
        </div>
      

      
      
        <div class="post-widgets">
        

        

        
          
          <div class="social_share">
            
            
               <div id="needsharebutton-postbottom">
                 <span class="btn">
                    <i class="fa fa-share-alt" aria-hidden="true"></i>
                 </span>
               </div>
            
          </div>
        
        </div>
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/08/02/kubernetes-metrics-server/" rel="prev" title="kubernetes全自动弹性伸缩组件">
                kubernetes全自动弹性伸缩组件 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="freeman" />
            
              <p class="site-author-name" itemprop="name">freeman</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">5</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">10</span>
                    <span class="site-state-item-name">标签</span>
                  
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/goudai" target="_blank" title="Github"><i class="fa fa-fw fa-globe"></i>Github</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#目标"><span class="nav-number">1.</span> <span class="nav-text">目标</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#镜像"><span class="nav-number">2.</span> <span class="nav-text">镜像</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#使用软件版本"><span class="nav-number">3.</span> <span class="nav-text">使用软件版本</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#主机布局"><span class="nav-number">4.</span> <span class="nav-text">主机布局</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#环境准备-以下操作请在每一台主机执行，请确保使用root用户"><span class="nav-number">5.</span> <span class="nav-text">环境准备(以下操作请在每一台主机执行，请确保使用root用户)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#linux环境设置"><span class="nav-number">5.1.</span> <span class="nav-text">linux环境设置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-安装"><span class="nav-number">5.2.</span> <span class="nav-text">docker 安装</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#一下操作任选一台MASTER节点操作即可（这里选择k8s-m1）"><span class="nav-number">6.</span> <span class="nav-text">一下操作任选一台MASTER节点操作即可（这里选择k8s-m1）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#开始自动化部署"><span class="nav-number">7.</span> <span class="nav-text">开始自动化部署</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#添加node节点"><span class="nav-number">8.</span> <span class="nav-text">添加node节点</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#添加插件"><span class="nav-number">9.</span> <span class="nav-text">添加插件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#部署kube-proxy-插件"><span class="nav-number">9.1.</span> <span class="nav-text">部署kube-proxy 插件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署flannel-插件"><span class="nav-number">9.2.</span> <span class="nav-text">部署flannel 插件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署coredns"><span class="nav-number">9.3.</span> <span class="nav-text">部署coredns</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署Dashboard"><span class="nav-number">9.4.</span> <span class="nav-text">部署Dashboard</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#kubectl-自动补全"><span class="nav-number">10.</span> <span class="nav-text">kubectl 自动补全</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考资料"><span class="nav-number">11.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">freeman</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.3.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
      <div id="needsharebutton-float">
        <span class="btn">
          <i class="fa fa-share-alt" aria-hidden="true"></i>
        </span>
      </div>
    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.3.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



  








  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  
  
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(function (item) {
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'Cr2HKMY3bprD6G5JG4tMzFIi-gzGzoHsz',
        appKey: 'dR05KdsOncKQ9yOhzhoiUOWN',
        placeholder: '',
        avatar:'mm',
        meta:guest,
        pageSize:'10' || 10,
        visitor: true
    });
  </script>



  





  

  

  

  

  
  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "box";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
      flOptions = {};
      
          flOptions.iconStyle = "box";
      
          flOptions.boxForm = "horizontal";
      
          flOptions.position = "middleRight";
      
          flOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-float', flOptions);
    
  </script>

  

  

  

  

  

  

</body>
</html>
